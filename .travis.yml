services:
  - docker
sudo: required

script:
  - docker login -u=${DOCKER_USER} -p=${DOCKER_PASSWORD}

  # uncomment these lines if you want to build and push base tools
  #- docker build --tag zikalino/autorest.devops.base -f Dockerfile-base .
  #- docker push zikalino/autorest.devops.base

  - docker build --tag zikalino/autorest.devops .
  - docker push zikalino/autorest.devops

  - git clone https://github.com/Azure/azure-rest-api-specs.git ~/azure-rest-api-specs
  - git clone https://audevbot:${GH_TOKEN}@github.com/audevbot/autorest.devops.debug.git ~/autorest.devops.debug
  - git clone https://audevbot:${GH_TOKEN}@github.com/Azure/magic-module-specs.git ~/magic-module-specs;
  - git clone https://github.com/vschina/magic-modules.git ~/magic-modules
  - echo $(pwd)
  - export CURRENT_PATH=$(pwd)
  - cd ~/autorest.devops.debug; git checkout autogenerated-${TRAVIS_BUILD_NUMBER} -- ~/autorest.devops.debug || git checkout -B autogenerated-${TRAVIS_BUILD_NUMBER}
  - mkdir -p ~/autorest.devops.debug/generated
  - rm -rf ~/autorest.devops.debug/generated/*
  #- docker run -t -i -v $CURRENT_PATH:/autorest.devops -w /autorest.devops autorest.devops npm install

  - 'cd $CURRENT_PATH/input;
     for d in *; do
        echo ---------------------------------------------------------------------------------;
        echo Processing: $d;
        echo ---------------------------------------------------------------------------------;
        docker run -t -i
        -v ~/azure-rest-api-specs:/azure-rest-api-specs
        -v ~/autorest.devops.debug/generated:/generated
        zikalino/autorest.devops
        autorest
        --azureresourceschema
        --use=/autorest.devops
        --python-sdks-folder=/generated
        --output-folder=/generated
        /autorest.devops/input/$d;
     done'

  # just try to set up and run magic modules
  #- 'echo ---------------------------------------------------------------------------------;
  #   echo Running Magic Modules;
  #   echo ---------------------------------------------------------------------------------;
  #   docker run -t -i
  #   -v $CURRENT_PATH:/autorest.devops
  #   -v ~/azure-rest-api-specs:/azure-rest-api-specs
  #   -v ~/autorest.devops.debug/generated:/generated
  #   -v ~/magic-modules:/magic-modules
  #   autorest.devops
  #   /bin/bash -c -l "
  #   ruby -v;
  #   cd /magic-modules;
  #   bundle install;
  #   git checkout azure_backend;
  #   bundle exec compiler -p products/azbatchaccount -e ansible -o /generated
  #   "'

after_success:
  - ls -al ~/autorest.devops.debug/generated
  - ls -al ~/autorest.devops.debug/generated/magic-modules-input
  - ls -al ~/autorest.devops.debug/generated/ansible-module-drafts
  - git config --global user.email "audevbot@microsoft.com"
  - git config --global user.name "audevbot"
  - cd ~/autorest.devops.debug ; git config credential.helper store
  - cd ~/magic-module-specs; git config credential.helper store
  - echo "https://audevbot:${GH_TOKEN}@github.com" > ~/.git-credentials

  - cd ~/autorest.devops.debug ; git add -A ; git commit -m "autogenerated-${TRAVIS_BUILD_NUMBER}" ; git push --set-upstream origin autogenerated-${TRAVIS_BUILD_NUMBER}
  - cd ~/magic-module-specs; (git checkout autogenerated-${TRAVIS_BUILD_NUMBER} || git checkout -B autogenerated-${TRAVIS_BUILD_NUMBER}) #; rm -rf products

  - cp -R ~/autorest.devops.debug/generated/magic-modules-input/batchapplication ~/magic-module-specs
  #- shopt -s globstar; cd ~/autorest.devops.debug/generated/magic-modules-input; cp --parents --no-clobber ./**/ansible.yaml ~/magic-module-specs; cp --parents --no-clobber ./**/terraform.yaml ~/magic-module-specs; cp --parents ./**/api.yaml ~/magic-module-specs
  #- shopt -s globstar; cd ~/autorest.devops.debug/generated/magic-modules-input/; cp --parents ./**/ansible.yaml ~/magic-module-specs; cp --parents ./**/terraform.yaml ~/magic-module-specs; cp --parents ./**/api.yaml ~/magic-module-specs
  - cd ~/magic-module-specs ; git add -A ; git commit -m "autogenerated-${TRAVIS_BUILD_NUMBER}" ; git push --set-upstream origin autogenerated-${TRAVIS_BUILD_NUMBER}
